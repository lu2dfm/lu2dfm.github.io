{{ define "main" }}
{{ $currentLang := .Language.Lang }}

{{- $contentKey :=  .File.BaseFileName -}} 

{{ $seriesData := index .Site.Data.series .Params.series }}
{{ $contentData := index $seriesData $contentKey }}


<!--
<pre>

{{ printf "Current template: %s" . }}
{{ printf "Kind: %s" .Kind }}
{{ printf "Type: %s" .Type }}
{{ printf "Layout: %s" .Layout }}
{{ printf "CurrentContentFile: %s" .File.Path }}
Current Language: {{ .Site.Language.Lang }}
Page URL: {{ .RelPermalink }}
IsTranslated: {{ .IsTranslated }}
Translations count: {{ len .Translations }}
AllTranslations count: {{ len .AllTranslations }}
Translations: {{ range .Translations }}{{ .Language.Lang }}: {{ .RelPermalink }} | {{ end }}
Section: {{ .Section }}
Type: {{ .Type }}
serie: {{ .Params.series }}
</pre>
<pre>
File Path: {{ .File.Path }}
File Dir: {{ .File.Dir }}
Language Lang: {{ .Language.Lang }}
Language ContentDir: {{ .Language.ContentDir }}


Mount Info:
{{- range .Site.AllPages -}}
  {{- if eq .File.LogicalName "contact.md" -}}
    File: {{ .File.Path }} | Lang: {{ .Language.Lang }} | URL: {{ .RelPermalink }}
 {{ else }}
    File: {{ .File.Path }} | Lang: {{ .Language.Lang }} | URL: {{ .RelPermalink }}
  {{- end -}}
{{- end -}}
</pre>
-->


{{ $nav :=  "navigation" }}
{{ with .Params.series_partial }}
{{ end }}

{{ if $contentData }}
    {{ $title := index $contentData.title $currentLang }}
    <article class="post">
      <header class="post__header">
          <h1 class="post__title">{{ $title }}</h1>
          {{- with index $contentData.lead $currentLang }}
          <p class="post__lead">{{ . }}</p>
          {{- end }}
          {{ with partial "post_meta.html" . -}}
          <div class="post__meta meta">{{ . }}</div>
          {{- end }}
      </header>


      <!-- Epigrafe -->
      {{ with index $contentData.epigrafe $currentLang }}
      <div class="epigrafe">
        <blockquote>
          {{ .texto | markdownify }}
          {{ with .autor }}<cite>— {{ . }}</cite>{{ end }}
        </blockquote>
      </div>
      {{ end }}
      {{- partial "post_toc.html" . -}}
      <div class="content post__content clearfix">


          {{ $mas_content := index $contentData.content $currentLang | markdownify }}
          {{ $content := $mas_content }}
          {{ $content = replaceRE `<a href="(https?://.+)">` `<a href="$1" target="_blank">` $content | safeHTML }}
          {{ $content = replaceRE `<a href="(mailto:.+)">` `<a href="$1" target="_blank">` $content | safeHTML }}
          {{ $content | safeHTML }}

        {{/* Insertar partial específico si está definido */}}
        {{ with .Params.series_partial }}
            {{ $partialPath := printf "partials/series/%s/%s" $.Params.series . }}
            {{ partial $partialPath $ }}
        {{ end }}


      </div>
    {{/*
        {{ if .Params.series }}
            <aside class="series-components">
              {{ partial "layouts/series/partials/navigation" . }}
              {{ partial "series/partials/index" . }}
            </aside>
         {{ end }}

    */}}
      {{- if .Params.tags }}
      <footer class="post__footer">
          {{ partial "post_tags.html" . }}
      </footer>
      {{- end }}
    </article>

      <!-- Navegación de series (tu código existente) -->
      {{ if .Params.series }}
        {{ $serie_actual := index .Params.series 0 }}
        {{ $posts_serie := where .Site.RegularPages ".Params.series" "intersect" (slice $serie_actual) }}
        {{ $posts_filtrados := where $posts_serie ".Params.serie_role" "ne" "index" }}
        {{ $mismo_idioma := where $posts_filtrados ".Language.Lang" .Language.Lang }}
        
        {{ if $mismo_idioma }}
        <nav class="series-navigation">
          <h3>Otros artículos de {{ upper $serie_actual }}:</h3>
          <ul>
          {{ range $mismo_idioma }}
            {{ if ne .Permalink $.Permalink }}
              <li><a href="{{ .Permalink }}">{{ .Title }}</a></li>
            {{ end }}
          {{ end }}
          </ul>
        </nav>
        {{ end }}
      {{ end }}
{{ else }}

<!-- Fallback completo para páginas sin data file -->
<div class="container flex">
  <div class="content">
    <main class="main">
      <article class="post">
        <header class="post__header">
          <h1 class="post__title">{{ .Title }}</h1>
        </header>
        <div class="post__content content">
          <div class="post__text">
            {{ .Content }}
          </div>
        </div>
      </article>
    </main>
  </div>
</div>
{{ end }}
{{ end }}
