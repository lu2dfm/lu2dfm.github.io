{{ $currentLang := .Language.Lang }}
{{- $contentKey := .File.BaseFileName -}}

{{ if and .Params.series (eq .Type "series") }}
    {{/* Manejo para pÃ¡ginas de series usando data files */}}
    {{ $seriesData := index .Site.Data.series .Params.series }}
    {{ $contentData := index $seriesData $contentKey }}
    
    {{ if $contentData }}
        {{/* Usar data de la serie */}}
        {{ $title := index $contentData.title $currentLang }}
        {{ $lead := index $contentData.lead $currentLang }}
        {{ $summary := index $contentData.summary $currentLang }}
        {{/* Si no hay summary en data, usar los primeros 150 chars del content */}}
        {{ if not $summary }}
            {{ $content := index $contentData.content $currentLang }}
            {{ $summary = $content | markdownify | plainify | truncate 150 }}
        {{ end }}
        
        <article class="list__item post">
            {{ partial "post_thumbnail.html" (dict "class" "list" "page" .) }}
            <header class="list__header">
                <h2 class="list__title post__title">
                    <a href="{{ .RelPermalink }}" rel="bookmark">
                        {{- if .Params.series }}
                            {{- $hasUpdates := partial "functions/has-series-updates.html" (dict "series" .Params.series "currentLang" $currentLang) }}
                            {{- if $hasUpdates }}
                                ðŸ§© âš¡{{ T "series_updated" }} 
                            {{- else }}
                                ðŸ§© 
                            {{- end }}
                        {{- end }}
                        {{ $title }}
                    </a>
                </h2>
                {{- with $lead }}
                <p class="list__lead post__lead">{{ $lead }}</p>
                {{- end }}
                {{ with partial "post_meta.html" . -}}
                <div class="list__meta meta">{{ . }}</div>
                {{- end }}
            </header>
            <div class="content list__excerpt post__content clearfix">
                {{ $summary | markdownify }}
            </div>
            {{- if .Site.Params.readmore }}
            <div class="list__footer clearfix">
                <a class="list__footer-readmore btn" href="{{ .RelPermalink }}">{{ T "read_more" }}</a>
            </div>
            {{- end }}
        </article>
    {{ else }}
        {{/* Fallback si no existe la data de la serie */}}
        <article class="list__item post">
            {{ partial "post_thumbnail.html" (dict "class" "list" "page" .) }}
            <header class="list__header">
                <h2 class="list__title post__title">
                    <a href="{{ .RelPermalink }}" rel="bookmark">
                        {{- if .Params.series }}
                            {{- $hasUpdates := partial "functions/has-series-updates.html" (dict "series" .Params.series "currentLang" $currentLang) }}
                            {{- if $hasUpdates }}
                                ðŸ§© âš¡{{ T "series_updated" }} 
                            {{- else }}
                                ðŸ§© 
                            {{- end }}
                        {{- end }}
                        {{ .Title }}
                    </a>
                </h2>
                {{- with .Params.lead }}
                <p class="list__lead post__lead">{{ . }}</p>
                {{- end }}
                {{ with partial "post_meta.html" . -}}
                <div class="list__meta meta">{{ . }}</div>
                {{- end }}
            </header>
            <div class="content list__excerpt post__content clearfix">
                {{ .Summary }}
            </div>
            {{- if .Site.Params.readmore }}
            {{- if .Truncated }}
            <div class="list__footer clearfix">
                <a class="list__footer-readmore btn" href="{{ .RelPermalink }}">{{ T "read_more" }}</a>
            </div>
            {{- end }}
            {{- end }}
        </article>
    {{ end }}
{{ else }}
    {{/* NUEVA LÃ“GICA: Manejo para posts normales que usan data files */}}
    {{/* Intentar buscar data file basado en el nombre del archivo */}}
    {{ $dataFile := index .Site.Data.content $contentKey }}

    
    {{ if $dataFile }}
        {{/* Post con data file - usar contenido multiidioma */}}
        {{ $title := index $dataFile.title $currentLang }}
        {{ $lead := index $dataFile.lead $currentLang }}
        {{ $summary := index $dataFile.summary $currentLang }}
        
        {{/* Si no hay summary en data, generar desde content */}}
        {{ if not $summary }}
            {{ $content := index $dataFile.content $currentLang }}
            {{ $summary = $content | markdownify | plainify | truncate 150 }}
        {{ end }}
        
        {{/* Si no hay tÃ­tulo en data file, usar el del frontmatter */}}
        {{ if not $title }}
            {{ $title = .Title }}
        {{ end }}
        
        <article class="list__item post">
            {{ partial "post_thumbnail.html" (dict "class" "list" "page" .) }}
            <header class="list__header">
                <h2 class="list__title post__title">
                    <a href="{{ .RelPermalink }}" rel="bookmark">
                        {{ $title }}
                    </a>
                </h2>
                {{- if $lead }}
                <p class="list__lead post__lead">{{ $lead }}</p>
                {{- else }}
                    {{- with .Params.lead }}
                    <p class="list__lead post__lead">{{ . }}</p>
                    {{- end }}
                {{- end }}
                {{ with partial "post_meta.html" . -}}
                <div class="list__meta meta">{{ . }}</div>
                {{- end }}
            </header>
            <div class="content list__excerpt post__content clearfix">
                {{ $summary | markdownify }}
            </div>
            {{- if .Site.Params.readmore }}
            <div class="list__footer clearfix">
                <a class="list__footer-readmore btn" href="{{ .RelPermalink }}">{{ T "read_more" }}</a>
            </div>
            {{- end }}
        </article>
    {{ else }}
        {{/* Post normal sin data file - comportamiento original */}}
        <article class="list__item post">
            {{ partial "post_thumbnail.html" (dict "class" "list" "page" .) }}
            <header class="list__header">
                <h2 class="list__title post__title">
                    <a href="{{ .RelPermalink }}" rel="bookmark">
                    {{ .Title }}
                    </a>
                </h2>
                {{- with .Params.lead }}
                <p class="list__lead post__lead">{{ . }}</p>
                {{- end }}
                {{ with partial "post_meta.html" . -}}
                <div class="list__meta meta">{{ . }}</div>
                {{- end }}
            </header>
            <div class="content list__excerpt post__content clearfix">
                {{ .Summary }}
            </div>
            {{- if .Site.Params.readmore }}
            {{- if .Truncated }}
            <div class="list__footer clearfix">
                <a class="list__footer-readmore btn" href="{{ .RelPermalink }}">{{ T "read_more" }}</a>
            </div>
            {{- end }}
            {{- end }}
        </article>
    {{ end }}
{{ end }}
